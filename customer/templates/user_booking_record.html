{% extends 'base.html' %}
{% load static %}
{% block head %}

<style>
   
    </style>
{% endblock %}
{% block content %}
<section class="hero-wrap hero-wrap-2 js-fullheight" style="background-image: url('{% static 'images/onlineBooking.jpeg'%}');" data-stellar-background-ratio="0.5">     
    <div class="overlay"></div>
    <div class="container">
      <div class="row no-gutters slider-text js-fullheight align-items-end justify-content-start">
        <div class="col-md-9 ftco-animate pb-5">
            <p class="breadcrumbs"><span class="mr-2"><a href="{% url 'home'%}">Home <i class="ion-ios-arrow-forward"></i></a></span> <span>Profile <i class="ion-ios-arrow-forward"></i></span></p>
          <h1 class="mb-3 bread">My Bookings</h1>
        </div>
      </div>
    </div>
  </section>
  <section class="ftco-section ftco-cart">
    <div class="container">
        <div class="container mt-4">
            

                <!-- Right Content (Booking Records) -->
                <div class="col-md-9" id="overflow-work">
                    <h3 style="margin-left:300px">Booking History</h3>
                    <div id="records-container">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th scope="col" class="sortable" onclick="sortTable(0)">Booking ID</th>
                                    <th scope="col" class="sortable" onclick="sortTable(1)">Car Make & Model</th>
                                    <th scope="col" class="sortable" onclick="sortTable(2)">Pickup Location</th>
                                    <th scope="col" class="sortable" onclick="sortTable(3)">Pickup Date</th>
                                    <th scope="col" class="sortable" onclick="sortTable(4)">Drop Date</th>
                                    <th scope="col" class="sortable" onclick="sortTable(5)">Receipt Amount</th>
                                    <th scope="col" class="sortable" onclick="sortTable(6)">Booking Status</th>
                                    <th scope="col" class="sortable" onclick="sortTable(7)">Payment Status</th>
                                    <th scope="col" class="sortable" onclick="sortTable(7)">action</th>

                                </tr>
                            </thead>
                            <tbody>
                                {% for booking in bookings %}
                                    <tr data-status="{{ booking.booking_status }}" data-payment="{{ booking.payment_status }}">
                                        <td> {{ booking.id }}</td>
                                        <td>{{ booking.car.make }} {{ booking.car.model }}</td>
                                        <td>{{ booking.pickup_location }}</td>
                                        <td>{{ booking.pickup_date }}</td>
                                        <td>{{ booking.drop_date }}</td>
                                        <td>₹{{ booking.receipt_amount }}</td>
                                        <td>
                                            <span class="badge 
                                                {% if booking.booking_status == 'pending' %}bg-warning{% endif %}
                                                {% if booking.booking_status == 'confirm' %}bg-success{% endif %}
                                                {% if booking.booking_status == 'complete' %}bg-primary{% endif %}
                                                {% if booking.booking_status == 'canceled' %}bg-danger{% endif %}
                                            ">
                                                {{ booking.booking_status }}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge 
                                                {% if booking.payment_status == 'pending' %}bg-warning{% endif %}
                                                {% if booking.payment_status == 'complete' %}bg-success{% endif %}
                                            ">
                                                {{ booking.payment_status }}
                                            </span>
                                            
                                        </td>
                                        {% if booking.booking_status == "confirm" %}
                                        <td>
                                            <button class="btn btn-info view-booking" data-booking-id="{{ booking.id }}">
                                                <i class="fas fa-eye"></i> View
                                            </button>
                                        </td>
                                    {% elif booking.booking_status == "canceled" %}
                                        <td>
                                            <span class="text-danger">Canceled</span>
                                        </td>
                                    {% else %}
                                        <td>
                                            <button class="btn btn-info cancle-booking" data-booking-id="{{ booking.id }}">
                                                <i class="fas fa-ban"></i> Cancel Booking
                                            </button>
                                        </td>
                                    {% endif %}
                                    
                                     </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>  <div id="confirmation-popup" class="modal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Are you sure you want to cancel the booking?</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">No</button>
                    <button type="button" class="btn btn-danger" id="confirm-cancel">Yes, Cancel Booking</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Success Message Popup -->
    <div id="success-popup" class="modal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Booking Canceled</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Your booking for the car <strong id="car-model-name"></strong> has been successfully canceled.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</section>




<!-- Modal for displaying booking details -->
<div class="modal fade" id="viewBookingModal" tabindex="-1" aria-labelledby="viewBookingModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewBookingModalLabel">Booking Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="booking-details">
                    <!-- The booking details will be inserted here dynamically via AJAX -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<section class="ftco-section ftco-no-pt bg-light">
    <div class="container">
        <div class="row justify-content-center">
      <div class="col-md-12 heading-section text-center ftco-animate mb-5">
          <span class="subheading">What we offer</span>
        <h2 class="mb-2">Available Vehicles</h2>
      </div>
    </div>
    <div class="row">
      <div class="col-md-12">
        <div class="carousel-car owl-carousel">
          {% for car in car_records %}
            <div class="item">
              <div class="car-wrap rounded ftco-animate">
                <div class="img rounded d-flex align-items-end" style="background-image: url('{{ car.image }}');"></div>
                <div class="text">
                  <h2 class="mb-0"><a href="#">{{car.model}}</a></h2>
                  <div class="d-flex mb-3">
                    <span class="cat">{{car.make}}</span>
                    <p class="price ml-auto">₹ {{car.price_per_hour}} <span>/hour</span></p>
                  </div>
                  <p class="d-flex mb-0 d-block">
                    <a href="{% url 'car_booking' car.id %}" class="btn btn-primary py-2 mr-1">Book now</a>
                    <a href="{% url 'car-single' car.id %}" class="btn btn-secondary py-2 ml-1">Details</a>
                    
                    <button
                      class="btn  py-2 mr-1 save-car-btn"
                      data-car-id="{{ car.id }}"
                      data-save-url="{% url 'save_car' car_id=0 %}"
                      >
                      {% if car.is_saved %}
                      <!-- Display saved icon -->
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-bookmark-check-fill" viewBox="0 0 16 16">
                          <path fill-rule="evenodd" d="M2 15.5V2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v13.5a.5.5 0 0 1-.74.439L8 13.069l-5.26 2.87A.5.5 0 0 1 2 15.5m8.854-9.646a.5.5 0 0 0-.708-.708L7.5 7.793 6.354 6.646a.5.5 0 1 0-.708.708l1.5 1.5a.5.5 0 0 0 .708 0z"/>
                      </svg>
                      {% else %}
                      <!-- Display unsaved icon -->
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-bookmark" viewBox="0 0 16 16">
                          <path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v13.5a.5.5 0 0 1-.777.416L8 13.101l-5.223 2.815A.5.5 0 0 1 2 15.5zm2-1a1 1 0 0 0-1 1v12.566l4.723-2.482a.5.5 0 0 1 .554 0L13 14.566V2a1 1 0 0 0-1-1z"/>
                      </svg>
                      {% endif %}
              
                  </button>
                  </p>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

    <!-- Favorite count display -->
  
    </div>
</section>
{% endblock %}
{% block extra_scripts%}
<script src="{% static 'js/save_car.js' %}"></script>

<script>
    $(document).ready(function () {
        // Attach click event to each 'View' icon
        $('.view-booking').on('click', function () {
          const bookingId = $(this).data('booking-id');  // Get the booking ID from the data attribute
    
          // Send an AJAX request to fetch booking details
          $.ajax({
            url: '/get-booking-details/' + bookingId + '/',  // URL to fetch booking details
            method: 'GET',
            dataType: 'json',
            success: function (data) {
              // Check if booking data was returned successfully
              if (data) {
                // Fill in the modal with the booking details
                const bookingDetails = `
                <strong>Car Details:</strong><br>
                <strong>Make:</strong> ${data.car_make} ${data.car_model}<br>
                <strong>Year:</strong> ${data.car_year}<br>
                <strong>Color:</strong> ${data.car_color}<br>
                <strong>Registration Number:</strong> ${data.car_registration_number}<br><br>
                <strong>Driver Details:</strong><br>
                <strong>Name:</strong> ${data.driver_name}<br>
                <strong>Email:</strong> ${data.driver_email}<br>
                <strong>Phone:</strong> ${data.driver_number}<br><br>

                <strong>User Details:<div class="container mt-4">
                <strong>Name:</strong> ${data.user_name}<br>
                <strong>Email:</strong> ${data.user_email}<br>
                <strong>Phone:</strong> ${data.user_phone}<br><br>
  
                <strong>Booking Details:</strong><br>
                <strong>Pickup Location:</strong> ${data.pickup_location}<br>

                <strong>Pickup Date:</strong> ${data.pickup_date}<br>
                <strong>Drop Date:</strong> ${data.drop_date}<br>
                <strong>Status:</strong> ${data.booking_status}<br>
                <strong>Amount:</strong> $${data.receipt_amount}<br>
                <strong>Booking Status:</strong> ${data.booking_status}<br>
                <strong>Payment Method:</strong> ${data.payment_status}<br>
                `;
                // Insert the booking details into the modal
                $('#booking-details').html(bookingDetails);
                
                // Show the modal
                $('#viewBookingModal').modal('show');
              } else {
                alert('Error: Booking details not found.');
              }
            },
            error: function (xhr, status, error) {
              alert('Error fetching booking details: ' + error);
            }
          });
        });
});
$(document).ready(function () {
    let bookingIdToCancel = null; 

    $('.cancel-booking').on('click', function () {
        bookingIdToCancel = $(this).data('booking-id');
        $('#booking-id').val(bookingIdToCancel);

        $('#cancelBookingModal').modal('show');
    });

    $('#confirm-cancel-btn').on('click', function () {
        const csrfToken = $('input[name="csrfmiddlewaretoken"]').val() || getCookie('csrftoken');  
        $.ajax({
            url: '/cancel-booking/' + bookingIdToCancel + '/',  
            method: 'POST',
            data: {
                csrfmiddlewaretoken: csrfToken, 
            },
            success: function (response) {
                if (response.success) {
                    $(`#booking-status-${bookingIdToCancel}`).html('<span class="badge bg-danger">Canceled</span>');
                    $('#cancelBookingModal').modal('hide');
                } else {
                    alert('Error: Could not cancel the booking.');
                }
            },
            error: function (xhr, status, error) {
                alert('Error canceling booking: ' + error);
            }
        });
    });
});

function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
$(document).ready(function() {
   
     $('.filter-option').click(function() {
        $('.filter-option').removeClass('active-filter');

        $(this).addClass('active-filter');

        var filterValue = $(this).data('filter');
    });
        let bookingId;
    
        // Show confirmation popup when cancel button is clicked
        $('.cancle-booking').click(function () {
            bookingId = $(this).data('booking-id');
            $('#confirmation-popup').modal('show');
        });
    
        // If user confirms cancellation, send AJAX request
        $('#confirm-cancel').click(function () {
            $.ajax({
                url: '/cancel-booking/' + bookingId + '/',  // Make sure to use the correct URL pattern
                method: 'POST',
                data: {
                    'booking_id': bookingId,
                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                },
                success: function (response) {
                    if (response.success) {
                        
                        $('[data-booking-id="' + bookingId + '"]').closest('.booking-row').find('.booking-status').text('Canceled');
                        
                        $('#car-model-name').text(response.car_model);
                        
                        $('#success-popup').modal('show');
                        $('#confirmation-popup').modal('hide');
                    } else {
                        alert('Failed to cancel booking.');
                    }
                },
                error: function () {
                    alert('Error while canceling the booking.');
                }
            });
        });
    
   
});


</script>
{% endblock%}