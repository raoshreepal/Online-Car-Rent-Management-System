{% extends 'base.html' %}
{% load static %}

{% block title %}Carbook - Login{% endblock %}
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

{% block content %}
<!-- Modal for displaying error messages -->
<div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="errorModalLabel">Error</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="modalMessage">
        <!-- Error message will be inserted here -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Hero section with background image -->
<section class="hero-wrap hero-wrap-2" style="background-image: url('{% static 'images/bg_3_1.jpeg' %}');" data-stellar-background-ratio="0.5">
    <div class="overlay"></div>
    <div class="container">
        <div class="row no-gutters slider-text js-fullheight align-items-end justify-content-start">
            <div class="col-md-9 ftco-animate pb-5">
                <p class="breadcrumbs"><span class="mr-2"><a href="{% url 'home'%}">Home <i class="ion-ios-arrow-forward"></i></a></span> <span>Login <i class="ion-ios-arrow-forward"></i></span></p>
                <h1 class="mb-3 bread">Login</h1>
            </div>
        </div>
    </div>
</section>


<!-- Login Form Section -->
<section class="ftco-section contact-section">
    <div class="container">
      {% if messages %}
    {% for message in messages %}
        <div class="alert alert-success">
            {{ message }}
        </div>
    {% endfor %}
{% endif %}

      <div class="row justify-content-center">
        <div class="col-md-7">
          <form method="post">
            {% csrf_token %}
        
            <div class="mb-3">
                <label for="{{ form.username.id_for_label }}" class="form-label">Username</label>
                {{ form.username }}
                {% if form.username.errors %}
                    <div class="text-danger">
                        {{ form.username.errors.0 }}
                    </div>
                {% endif %}
            </div>
        
            <div class="mb-3">
                <label for="{{ form.password.id_for_label }}" class="form-label">Password</label>
                {{ form.password }}
                {% if form.password.errors %}
                    <div class="text-danger">
                        {{ form.password.errors.0 }}
                    </div>
                {% endif %}
            </div>
        
            <button type="submit" class="btn btn-primary">Login</button>
        </form>
        
        {% if messages %}
            <div class="mt-3">
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }}">{{ message }}</div>
                {% endfor %}
            </div>
        {% endif %}
        
            <!-- Register and Forgot Password Links -->
            <div class="form-group">
              <b>If you don't have an account, <a href="{% url 'register' %}">Sign-up now</a></b>
            </div>
            <div class="form-group">
              <b>If you can't remember your password, <a href="{% url 'update_password' %}">Update now</a></b>
            </div>
          
        </div>
      </div>
    </div>
</section>

{% endblock %}
{% block extra_scripts %}
<!-- Bootstrap JS and Popper.js -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js"></script>

<script>
  $(document).ready(function() {
    $("#loginForm").submit(function(event) {
        event.preventDefault();  // Prevent the default form submission behavior

        var formData = $(this).serialize();  // Serialize the form data

        $.ajax({
            url: '{% url "login" %}',  // The URL for your login view
            type: 'POST',
           
            data: formData,  // Send the serialized form data
            success: function(response) {
                // Redirect to home if login is successful
                window.location.href = '{% url "home" %}';
                
            },
            error: function(response) {
                // Check if thereâ€™s a custom error message in the response
                var errorMessage = "An error occurred. Please try again.";  // Default error message

                if (response.responseJSON && response.responseJSON.message) {
                    errorMessage = response.responseJSON.message;  // Use the message from the server
                }

                // Display the error message in the modal
                $('#modalMessage').text(errorMessage);
                var errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
                errorModal.show();  // Show the error modal
            }
        });
    });

    // Handle the "Sign-up now" button click from the modal
    $('#signUpBtn').click(function() {
        window.location.href = '{% url "register" %}';  // Redirect to the registration page
    });
});

</script>
{% endblock %}
